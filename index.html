import os
import json
import logging
import sqlite3
from datetime import datetime
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Application, CommandHandler, MessageHandler, filters, CallbackContext, CallbackQueryHandler
from telegram.constants import ParseMode

# ========== –ù–ê–°–¢–†–û–ô–ö–ê –õ–û–ì–ò–†–û–í–ê–ù–ò–Ø ==========
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# ========== –ó–ê–ì–†–£–ó–ö–ê –¢–û–ö–ï–ù–ê ==========
TOKEN = "8234279270:AAE45bp2T9tZZFMfAIik2V6mZ6ABRSwtDtY"  # –í–ê–® –¢–û–ö–ï–ù

if not TOKEN:
    logger.error("‚ùå –û–®–ò–ë–ö–ê: –¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω!")
    exit(1)

logger.info(f"‚úÖ –¢–æ–∫–µ–Ω –∑–∞–≥—Ä—É–∂–µ–Ω!")

# ========== –ù–ê–°–¢–†–û–ô–ö–ò ==========
WEB_APP_URL = "https://protective12196.github.io/cookie-game/index.html"  # –í–ê–®–ê –°–°–´–õ–ö–ê
DB_NAME = 'game_stats.db'

# ========== –ë–ê–ó–ê –î–ê–ù–ù–´–• ==========
def init_db():
    """–°–æ–∑–¥–∞–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç"""
    conn = sqlite3.connect(DB_NAME)
    cursor = conn.cursor()
    
    # –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS users (
            user_id INTEGER PRIMARY KEY,
            username TEXT,
            first_name TEXT,
            last_name TEXT,
            photo_url TEXT,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
    ''')
    
    # –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS game_results (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id INTEGER,
            score INTEGER,
            bombs INTEGER,
            cookies_found INTEGER,
            total_cookies INTEGER,
            game_won BOOLEAN,
            difficulty_multiplier REAL,
            played_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (user_id) REFERENCES users (user_id)
        )
    ''')
    
    # –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS leaderboard (
            user_id INTEGER PRIMARY KEY,
            best_score INTEGER DEFAULT 0,
            total_games INTEGER DEFAULT 0,
            total_score INTEGER DEFAULT 0,
            last_played TIMESTAMP,
            avg_score REAL DEFAULT 0,
            FOREIGN KEY (user_id) REFERENCES users (user_id)
        )
    ''')
    
    # –¢–∞–±–ª–∏—Ü–∞ –¥–ª—è –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ —Ä–µ–π—Ç–∏–Ω–≥–∞
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS global_stats (
            total_players INTEGER DEFAULT 0,
            total_games INTEGER DEFAULT 0,
            total_score INTEGER DEFAULT 0,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
    ''')
    
    # –í—Å—Ç–∞–≤–ª—è–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –µ—Å–ª–∏ —Ç–∞–±–ª–∏—Ü–∞ –ø—É—Å—Ç–∞
    cursor.execute('SELECT COUNT(*) FROM global_stats')
    if cursor.fetchone()[0] == 0:
        cursor.execute('INSERT INTO global_stats (total_players, total_games, total_score) VALUES (0, 0, 0)')
    
    conn.commit()
    conn.close()
    logger.info("‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞")

def save_user(user_data):
    """–°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ"""
    conn = sqlite3.connect(DB_NAME)
    cursor = conn.cursor()
    
    cursor.execute('''
        INSERT OR REPLACE INTO users 
        (user_id, username, first_name, last_name, photo_url, updated_at)
        VALUES (?, ?, ?, ?, ?, CURRENT_TIMESTAMP)
    ''', (
        user_data['id'],
        user_data.get('username'),
        user_data.get('first_name'),
        user_data.get('last_name'),
        user_data.get('photo_url')
    ))
    
    conn.commit()
    conn.close()

def save_game_result(user_id, game_data):
    """–°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏–≥—Ä—ã"""
    conn = sqlite3.connect(DB_NAME)
    cursor = conn.cursor()
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–µ—Ç–∞–ª–∏ –∏–≥—Ä—ã
    cursor.execute('''
        INSERT INTO game_results 
        (user_id, score, bombs, cookies_found, total_cookies, game_won, difficulty_multiplier)
        VALUES (?, ?, ?, ?, ?, ?, ?)
    ''', (
        user_id,
        game_data.get('score', 0),
        game_data.get('bombs', 5),
        game_data.get('cookies_found', 0),
        game_data.get('maxCookies', 20),
        game_data.get('gameWon', False),
        game_data.get('difficultyMultiplier', 1.0)
    ))
    
    # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    cursor.execute('''
        SELECT 
            MAX(score) as best_score,
            COUNT(*) as total_games,
            SUM(score) as total_score
        FROM game_results 
        WHERE user_id = ?
    ''', (user_id,))
    
    result = cursor.fetchone()
    best_score = result[0] or 0
    total_games = result[1] or 0
    total_score = result[2] or 0
    avg_score = total_score / total_games if total_games > 0 else 0
    
    # –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É –ª–∏–¥–µ—Ä–æ–≤
    cursor.execute('''
        INSERT OR REPLACE INTO leaderboard 
        (user_id, best_score, total_games, total_score, last_played, avg_score)
        VALUES (?, ?, ?, ?, CURRENT_TIMESTAMP, ?)
    ''', (user_id, best_score, total_games, total_score, avg_score))
    
    # –û–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    cursor.execute('''
        UPDATE global_stats 
        SET total_games = total_games + 1,
            total_score = total_score + ?,
            updated_at = CURRENT_TIMESTAMP
    ''', (game_data.get('score', 0),))
    
    # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤
    cursor.execute('SELECT COUNT(DISTINCT user_id) FROM game_results')
    total_players = cursor.fetchone()[0]
    cursor.execute('UPDATE global_stats SET total_players = ?', (total_players,))
    
    conn.commit()
    conn.close()
    logger.info(f"‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}: {game_data.get('score', 0)} –æ—á–∫–æ–≤")

def get_leaderboard(limit=10, days=None):
    """–ü–æ–ª—É—á–∞–µ–º —Ç–æ–ø –∏–≥—Ä–æ–∫–æ–≤ —Å —Ñ–∏–ª—å—Ç—Ä–æ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏"""
    conn = sqlite3.connect(DB_NAME)
    cursor = conn.cursor()
    
    if days:
        # –¢–æ–ø –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ N –¥–Ω–µ–π
        cursor.execute('''
            SELECT 
                u.user_id,
                u.first_name,
                u.username,
                u.photo_url,
                MAX(gr.score) as best_score,
                COUNT(gr.id) as games_played,
                AVG(gr.score) as avg_score
            FROM game_results gr
            JOIN users u ON gr.user_id = u.user_id
            WHERE gr.played_at >= datetime('now', ?)
            GROUP BY gr.user_id
            ORDER BY best_score DESC
            LIMIT ?
        ''', (f'-{days} days', limit))
    else:
        # –û–±—â–∏–π —Ç–æ–ø
        cursor.execute('''
            SELECT 
                u.user_id,
                u.first_name,
                u.username,
                u.photo_url,
                l.best_score,
                l.total_games as games_played,
                l.avg_score
            FROM leaderboard l
            JOIN users u ON l.user_id = u.user_id
            WHERE l.best_score > 0
            ORDER BY l.best_score DESC
            LIMIT ?
        ''', (limit,))
    
    rows = cursor.fetchall()
    conn.close()
    
    return [
        {
            'id': row[0],
            'first_name': row[1],
            'username': row[2],
            'photo_url': row[3],
            'score': row[4],
            'games': row[5],
            'avg_score': round(row[6], 1) if row[6] else 0
        }
        for row in rows
    ]

def get_user_stats(user_id):
    """–ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    conn = sqlite3.connect(DB_NAME)
    cursor = conn.cursor()
    
    cursor.execute('''
        SELECT 
            l.best_score,
            l.total_games,
            l.total_score,
            l.avg_score,
            COUNT(DISTINCT DATE(gr.played_at)) as days_played,
            MAX(gr.played_at) as last_game
        FROM leaderboard l
        LEFT JOIN game_results gr ON l.user_id = gr.user_id
        WHERE l.user_id = ?
        GROUP BY l.user_id
    ''', (user_id,))
    
    row = cursor.fetchone()
    
    # –ü–æ–ª—É—á–∞–µ–º –º–µ—Å—Ç–æ –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ
    cursor.execute('''
        SELECT COUNT(*) + 1 
        FROM leaderboard 
        WHERE best_score > (SELECT best_score FROM leaderboard WHERE user_id = ?)
    ''', (user_id,))
    rank = cursor.fetchone()[0] or 1
    
    conn.close()
    
    if row:
        return {
            'best_score': row[0] or 0,
            'total_games': row[1] or 0,
            'total_score': row[2] or 0,
            'avg_score': round(row[3] or 0, 1),
            'days_played': row[4] or 0,
            'last_game': row[5],
            'rank': rank
        }
    return {'best_score': 0, 'total_games': 0, 'total_score': 0, 'avg_score': 0, 'days_played': 0, 'rank': 1}

def get_global_stats():
    """–ü–æ–ª—É—á–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É"""
    conn = sqlite3.connect(DB_NAME)
    cursor = conn.cursor()
    
    cursor.execute('''
        SELECT 
            total_players,
            total_games,
            total_score,
            updated_at
        FROM global_stats
    ''')
    
    row = cursor.fetchone()
    conn.close()
    
    if row:
        avg_score = row[2] / row[1] if row[1] > 0 else 0
        return {
            'total_players': row[0],
            'total_games': row[1],
            'total_score': row[2],
            'avg_score': round(avg_score, 1),
            'updated_at': row[3]
        }
    return {'total_players': 0, 'total_games': 0, 'total_score': 0, 'avg_score': 0}

# ========== –ö–û–ú–ê–ù–î–´ –ë–û–¢–ê ==========
async def start(update: Update, context: CallbackContext):
    """–ö–æ–º–∞–Ω–¥–∞ /start"""
    user = update.effective_user
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    save_user({
        'id': user.id,
        'username': user.username,
        'first_name': user.first_name,
        'last_name': user.last_name,
        'photo_url': user.photo_url if hasattr(user, 'photo_url') else None
    })
    
    # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –∫–Ω–æ–ø–∫–æ–π –∏–≥—Ä—ã
    keyboard = [
        [InlineKeyboardButton("üéÆ –ò–ì–†–ê–¢–¨", web_app={'url': WEB_APP_URL})],
        [InlineKeyboardButton("üìä –ú–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data='mystats'),
         InlineKeyboardButton("üèÜ –¢–æ–ø –∏–≥—Ä–æ–∫–æ–≤", callback_data='top')],
        [InlineKeyboardButton("üìà –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data='global'),
         InlineKeyboardButton("‚ùì –ü–æ–º–æ—â—å", callback_data='help')]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    welcome_text = f"""
    üëã –ü—Ä–∏–≤–µ—Ç, {user.first_name}!

    üç™ **–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –∏–≥—Ä—É "–ü–µ—á–µ–Ω—å–∫–∏ –∏ –ë–æ–º–±—ã"!** üí£

    üéÆ **–ö–∞–∫ –∏–≥—Ä–∞—Ç—å:**
    1. –ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É "üéÆ –ò–ì–†–ê–¢–¨"
    2. –ò–≥—Ä–∞ –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –ø—Ä—è–º–æ –≤ Telegram
    3. –ö–ª–∏–∫–∞–π –Ω–∞ –∫–ª–µ—Ç–∫–∏ –∏ –Ω–∞—Ö–æ–¥–∏ –ø–µ—á–µ–Ω—å–∫–∏
    4. –ò–∑–±–µ–≥–∞–π –±–æ–º–±!

    üèÜ **–î–æ—Å—Ç—É–ø–Ω–æ –¥–æ 24 –±–æ–º–±!** –ë–æ–ª—å—à–µ –±–æ–º–± = –±–æ–ª—å—à–µ –æ—á–∫–æ–≤!

    –£–¥–∞—á–∏! üöÄ
    """
    
    await update.message.reply_text(
        welcome_text,
        reply_markup=reply_markup,
        parse_mode=ParseMode.MARKDOWN
    )

async def stats_command(update: Update, context: CallbackContext):
    """–ö–æ–º–∞–Ω–¥–∞ /stats"""
    user = update.effective_user
    stats = get_user_stats(user.id)
    
    text = f"""
    üìä **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–≥—Ä–æ–∫–∞ {user.first_name}:**

    üèÜ **–õ—É—á—à–∏–π —Å—á–µ—Ç:** {stats['best_score']} –æ—á–∫–æ–≤
    üìä **–ú–µ—Å—Ç–æ –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ:** #{stats['rank']}
    üéÆ **–í—Å–µ–≥–æ –∏–≥—Ä:** {stats['total_games']}
    ‚≠ê **–°—Ä–µ–¥–Ω–∏–π —Å—á–µ—Ç:** {stats['avg_score']}
    üìà **–í—Å–µ–≥–æ –æ—á–∫–æ–≤:** {stats['total_score']}
    üìÖ **–î–Ω–µ–π –∏–≥—Ä—ã:** {stats['days_played']}
    
    –•–æ—á–µ—à—å —É–ª—É—á—à–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç? –ñ–º–∏ "üéÆ –ò–ì–†–ê–¢–¨"! üí™
    """
    
    await update.message.reply_text(text, parse_mode=ParseMode.MARKDOWN)

async def top_command(update: Update, context: CallbackContext):
    """–ö–æ–º–∞–Ω–¥–∞ /top - —Ç–æ–ø –∏–≥—Ä–æ–∫–æ–≤"""
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º inline –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ —Ç–æ–ø–∞
    keyboard = [
        [InlineKeyboardButton("üèÜ –û–±—â–∏–π —Ç–æ–ø", callback_data='top_all')],
        [InlineKeyboardButton("üî• –¢–æ–ø –∑–∞ 7 –¥–Ω–µ–π", callback_data='top_7')],
        [InlineKeyboardButton("‚ö° –¢–æ–ø –∑–∞ 1 –¥–µ–Ω—å", callback_data='top_1')],
        [InlineKeyboardButton("üìä –ú–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data='mystats')]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await update.message.reply_text(
        "üéÆ **–í—ã–±–µ—Ä–∏ —Ç–∏–ø —Ä–µ–π—Ç–∏–Ω–≥–∞:**",
        reply_markup=reply_markup,
        parse_mode=ParseMode.MARKDOWN
    )

async def show_top(update: Update, context: CallbackContext, days=None):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ø –∏–≥—Ä–æ–∫–æ–≤"""
    query = update.callback_query
    await query.answer()
    
    if days == 7:
        top_players = get_leaderboard(10, days=7)
        title = "üèÜ **–¢–û–ü-10 –ò–ì–†–û–ö–û–í (7 –¥–Ω–µ–π):**"
    elif days == 1:
        top_players = get_leaderboard(10, days=1)
        title = "üèÜ **–¢–û–ü-10 –ò–ì–†–û–ö–û–í (1 –¥–µ–Ω—å):**"
    else:
        top_players = get_leaderboard(10)
        title = "üèÜ **–¢–û–ü-10 –ò–ì–†–û–ö–û–í:**"
    
    if not top_players:
        await query.edit_message_text(
            "üèÜ –ü–æ–∫–∞ –Ω–∏–∫—Ç–æ –Ω–µ –∏–≥—Ä–∞–ª! –ë—É–¥—å –ø–µ—Ä–≤—ã–º! üöÄ",
            parse_mode=ParseMode.MARKDOWN
        )
        return
    
    text = f"{title}\n\n"
    
    medals = ["ü•á", "ü•à", "ü•â", "4Ô∏è‚É£", "5Ô∏è‚É£", "6Ô∏è‚É£", "7Ô∏è‚É£", "8Ô∏è‚É£", "9Ô∏è‚É£", "üîü"]
    
    for i, player in enumerate(top_players):
        if i < 10:
            medal = medals[i]
        else:
            medal = f"{i+1}."
        
        username = f"@{player['username']}" if player['username'] else player['first_name']
        text += f"{medal} **{username}**\n"
        text += f"   üèÜ {player['score']} –æ—á–∫–æ–≤"
        text += f" | üéÆ {player['games']} –∏–≥—Ä"
        text += f" | ‚≠ê {player['avg_score']}\n\n"
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –¥–ª—è –¥—Ä—É–≥–∏—Ö —Ç–æ–ø–æ–≤
    keyboard = []
    if days != 7:
        keyboard.append([InlineKeyboardButton("üî• –¢–æ–ø –∑–∞ 7 –¥–Ω–µ–π", callback_data='top_7')])
    if days != 1:
        keyboard.append([InlineKeyboardButton("‚ö° –¢–æ–ø –∑–∞ 1 –¥–µ–Ω—å", callback_data='top_1')])
    if days is not None:
        keyboard.append([InlineKeyboardButton("üèÜ –û–±—â–∏–π —Ç–æ–ø", callback_data='top_all')])
    keyboard.append([InlineKeyboardButton("üìä –ú–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data='mystats')])
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await query.edit_message_text(
        text,
        reply_markup=reply_markup,
        parse_mode=ParseMode.MARKDOWN
    )

async def global_stats_command(update: Update, context: CallbackContext):
    """–ö–æ–º–∞–Ω–¥–∞ /global - –≥–ª–æ–±–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞"""
    query = update.callback_query
    if query:
        await query.answer()
    
    stats = get_global_stats()
    
    text = f"""
    üìà **–ì–õ–û–ë–ê–õ–¨–ù–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ò–ì–†–´:**

    üë• **–í—Å–µ–≥–æ –∏–≥—Ä–æ–∫–æ–≤:** {stats['total_players']}
    üéÆ **–í—Å–µ–≥–æ —Å—ã–≥—Ä–∞–Ω–æ –∏–≥—Ä:** {stats['total_games']}
    üèÜ **–í—Å–µ–≥–æ –Ω–∞–±—Ä–∞–Ω–æ –æ—á–∫–æ–≤:** {stats['total_score']}
    ‚≠ê **–°—Ä–µ–¥–Ω–∏–π —Å—á–µ—Ç:** {stats['avg_score']}
    
    üïê **–û–±–Ω–æ–≤–ª–µ–Ω–æ:** {stats['updated_at'][:19] if stats['updated_at'] else '—Ç–æ–ª—å–∫–æ —á—Ç–æ'}
    
    üéØ **–ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Å—è –∫ –∏–≥—Ä–µ –∏ —Å—Ç–∞–Ω—å –ª—É—á—à–∏–º!** üöÄ
    """
    
    if query:
        await query.edit_message_text(text, parse_mode=ParseMode.MARKDOWN)
    else:
        await update.message.reply_text(text, parse_mode=ParseMode.MARKDOWN)

async def help_command(update: Update, context: CallbackContext):
    """–ö–æ–º–∞–Ω–¥–∞ /help"""
    query = update.callback_query
    if query:
        await query.answer()
    
    help_text = """
    üÜò **–ü—Ä–∞–≤–∏–ª–∞ –∏–≥—Ä—ã "–ü–µ—á–µ–Ω—å–∫–∏ –∏ –ë–æ–º–±—ã"**

    üéØ **–¶–µ–ª—å:** –ù–∞–π—Ç–∏ –≤—Å–µ –ø–µ—á–µ–Ω—å–∫–∏, –∏–∑–±–µ–≥–∞—è –±–æ–º–±!

    üìñ **–ü—Ä–∞–≤–∏–ª–∞:**
    ‚Ä¢ –ò–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ: 5x5 –∫–ª–µ—Ç–æ–∫
    ‚Ä¢ üç™ –ü–µ—á–µ–Ω—å–∫–∞ = +20 –æ—á–∫–æ–≤
    ‚Ä¢ üí£ –ë–æ–º–±–∞ = –∫–æ–Ω–µ—Ü –∏–≥—Ä—ã
    ‚Ä¢ –ù–∞–π–¥–∏ –í–°–ï –ø–µ—á–µ–Ω—å–∫–∏ –¥–ª—è –ø–æ–±–µ–¥—ã!
    ‚Ä¢ **–ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –¥–æ 24 –±–æ–º–±!**

    üéÆ **–ö–∞–∫ –∏–≥—Ä–∞—Ç—å:**
    1. –ù–∞–∂–º–∏ "üéÆ –ò–ì–†–ê–¢–¨"
    2. –í—ã–±–µ—Ä–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–æ–º–± (1-24)
    3. –ö–ª–∏–∫–∞–π –Ω–∞ –∫–ª–µ—Ç–∫–∏ —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã–≤–∞—Ç—å –∏—Ö
    4. –ë–æ–ª—å—à–µ –±–æ–º–± = –±–æ–ª—å—à–µ –æ—á–∫–æ–≤ –∑–∞ –ø–µ—á–µ–Ω—å–∫—É!

    üìä **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:**
    ‚Ä¢ –í—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è
    ‚Ä¢ /top - —Ç–æ–ø –∏–≥—Ä–æ–∫–æ–≤
    ‚Ä¢ /stats - —Ç–≤–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    ‚Ä¢ /global - –≥–ª–æ–±–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

    üèÜ **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
    ‚Ä¢ –¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
    ‚Ä¢ –ú–æ–∂–Ω–æ –ø–æ–¥–µ–ª–∏—Ç—å—Å—è —Å–≤–æ–∏–º —Ä–µ–∫–æ—Ä–¥–æ–º
    ‚Ä¢ –î–æ—Å—Ç—É–ø–Ω—ã —Ä–∞–∑–Ω—ã–µ —Ç–∏–ø—ã —Ä–µ–π—Ç–∏–Ω–≥–æ–≤

    –£–¥–∞—á–∏! üçÄ
    """
    
    if query:
        await query.edit_message_text(help_text, parse_mode=ParseMode.MARKDOWN)
    else:
        await update.message.reply_text(help_text, parse_mode=ParseMode.MARKDOWN)

async def handle_web_app_data(update: Update, context: CallbackContext):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"""
    try:
        if update.message and update.message.web_app_data:
            user = update.effective_user
            data = update.message.web_app_data.data
            
            logger.info(f"üì® –î–∞–Ω–Ω—ã–µ –æ—Ç {user.first_name} ({user.id})")
            
            try:
                game_data = json.loads(data)
            except json.JSONDecodeError as e:
                logger.error(f"‚ùå –û—à–∏–±–∫–∞ JSON: {e}")
                return
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            save_game_result(user.id, game_data)
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç
            score = game_data.get('score', 0)
            game_won = game_data.get('gameWon', False)
            bombs = game_data.get('bombs', 5)
            
            # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
            stats = get_user_stats(user.id)
            
            if game_won:
                if score > stats['best_score']:
                    message = f"""
                    üéâ **–ù–û–í–´–ô –†–ï–ö–û–†–î! –ü–û–ë–ï–î–ê!** üèÜ

                    üèÜ **–¢–≤–æ–π —Å—á–µ—Ç:** {score} –æ—á–∫–æ–≤
                    üí£ **–ë–æ–º–±:** {bombs}
                    üìà **–ü—Ä–µ–¥—ã–¥—É—â–∏–π —Ä–µ–∫–æ—Ä–¥:** {stats['best_score']}
                    ü•á **–£–ª—É—á—à–µ–Ω–∏–µ:** +{score - stats['best_score']}

                    –û—Ç–ª–∏—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç! –¢—ã –≤ —Ç–æ–ø–µ! üöÄ
                    """
                else:
                    message = f"""
                    üéâ **–ü–û–ë–ï–î–ê!**

                    üèÜ **–¢–≤–æ–π —Å—á–µ—Ç:** {score} –æ—á–∫–æ–≤
                    üí£ **–ë–æ–º–±:** {bombs}
                    üìä **–õ—É—á—à–∏–π —Å—á–µ—Ç:** {stats['best_score']}

                    –•–æ—Ä–æ—à–∞—è –∏–≥—Ä–∞! üí™
                    """
            else:
                message = f"""
                üí• **–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞**

                üèÜ **–¢–≤–æ–π —Å—á–µ—Ç:** {score} –æ—á–∫–æ–≤
                üí£ **–ë–æ–º–±:** {bombs}
                üìä **–õ—É—á—à–∏–π —Å—á–µ—Ç:** {stats['best_score']}

                –ù–µ —Ä–∞—Å—Å—Ç—Ä–∞–∏–≤–∞–π—Å—è! –ü–æ–ø—Ä–æ–±—É–π –µ—â–µ —Ä–∞–∑! üçÄ
                """
            
            # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è —à–∞—Ä–∏–Ω–≥–∞
            keyboard = [
                [InlineKeyboardButton("üì§ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Ä–µ–∫–æ—Ä–¥–æ–º", callback_data=f'share_{score}')],
                [InlineKeyboardButton("üéÆ –ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞", web_app={'url': WEB_APP_URL})],
                [InlineKeyboardButton("üèÜ –¢–æ–ø –∏–≥—Ä–æ–∫–æ–≤", callback_data='top')]
            ]
            reply_markup = InlineKeyboardMarkup(keyboard)
            
            await update.message.reply_text(
                message,
                reply_markup=reply_markup,
                parse_mode=ParseMode.MARKDOWN
            )
            
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ web app –¥–∞–Ω–Ω—ã—Ö: {e}")

async def button_callback(update: Update, context: CallbackContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ inline –∫–Ω–æ–ø–æ–∫"""
    query = update.callback_query
    await query.answer()
    
    if query.data == 'mystats':
        user = query.from_user
        stats = get_user_stats(user.id)
        text = f"""
        üìä **–¢–≤–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:**

        üèÜ **–õ—É—á—à–∏–π —Å—á–µ—Ç:** {stats['best_score']}
        ü•á **–ú–µ—Å—Ç–æ –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ:** #{stats['rank']}
        üéÆ **–ò–≥—Ä:** {stats['total_games']}
        ‚≠ê **–°—Ä–µ–¥–Ω–∏–π:** {stats['avg_score']}
        
        –ü—Ä–æ–¥–æ–ª–∂–∞–π –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ! üí™
        """
        await query.edit_message_text(text, parse_mode=ParseMode.MARKDOWN)
        
    elif query.data == 'top':
        await top_command(update, context)
        
    elif query.data == 'top_all':
        await show_top(update, context)
        
    elif query.data == 'top_7':
        await show_top(update, context, days=7)
        
    elif query.data == 'top_1':
        await show_top(update, context, days=1)
        
    elif query.data == 'global':
        await global_stats_command(update, context)
        
    elif query.data == 'help':
        await help_command(update, context)
        
    elif query.data.startswith('share_'):
        score = query.data.split('_')[1]
        user = query.from_user
        game_url = WEB_APP_URL
        
        share_text = f"""
        üç™üí£ *–ú–æ–π —Ä–µ–∫–æ—Ä–¥ –≤ –∏–≥—Ä–µ "–ü–µ—á–µ–Ω—å–∫–∏ –∏ –ë–æ–º–±—ã": {score} –æ—á–∫–æ–≤!*
        
        üéÆ *–ü–æ–ø—Ä–æ–±—É–π –ø–æ–±–∏—Ç—å –º–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç!*
        {game_url}
        
        #–ü–µ—á–µ–Ω—å–∫–∏–ò–ë–æ–º–±—ã #TelegramGame #–ò–≥—Ä–∞
        """
        
        # –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º –ø–æ–¥–µ–ª–∏—Ç—å—Å—è
        keyboard = [
            [InlineKeyboardButton("üì§ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –≤ Telegram", 
                                 url=f"https://t.me/share/url?url={game_url}&text=üç™üí£%20–ú–æ–π%20—Ä–µ–∫–æ—Ä–¥%20–≤%20–∏–≥—Ä–µ%20–ü–µ—á–µ–Ω—å–∫–∏%20–∏%20–ë–æ–º–±—ã:%20{score}%20–æ—á–∫–æ–≤!%0A%0AüéÆ%20–ü–æ–ø—Ä–æ–±—É–π%20–ø–æ–±–∏—Ç—å%20–º–æ–π%20—Ä–µ–∑—É–ª—å—Ç–∞—Ç!")],
            [InlineKeyboardButton("üéÆ –ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞", web_app={'url': WEB_APP_URL})]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)
        
        await query.edit_message_text(
            "üì§ **–ü–æ–¥–µ–ª–∏—Å—å —Å–≤–æ–∏–º —Ä–µ–∫–æ—Ä–¥–æ–º —Å –¥—Ä—É–∑—å—è–º–∏!**\n\n" + share_text,
            reply_markup=reply_markup,
            parse_mode=ParseMode.MARKDOWN
        )

# ========== –ó–ê–ü–£–°–ö –ë–û–¢–ê ==========
def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞"""
    logger.info("üöÄ –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞...")
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
    init_db()
    
    # –°–æ–∑–¥–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±–æ—Ç–∞
    application = Application.builder().token(TOKEN).build()
    
    # –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥
    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("stats", stats_command))
    application.add_handler(CommandHandler("top", top_command))
    application.add_handler(CommandHandler("global", global_stats_command))
    application.add_handler(CommandHandler("help", help_command))
    
    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    application.add_handler(MessageHandler(filters.StatusUpdate.WEB_APP_DATA, handle_web_app_data))
    
    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ inline –∫–Ω–æ–ø–æ–∫
    application.add_handler(CallbackQueryHandler(button_callback))
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
    logger.info("‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω!")
    logger.info(f"üåê –°—Å—ã–ª–∫–∞ –Ω–∞ –∏–≥—Ä—É: {WEB_APP_URL}")
    logger.info("üìä –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ —Å –ª–∏–¥–µ—Ä–±–æ—Ä–¥–æ–º!")
    
    application.run_polling(allowed_updates=Update.ALL_TYPES)

if __name__ == '__main__':
    main()
